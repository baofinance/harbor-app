type Deposit @entity(immutable: true) {
  id: ID! # {contractAddress}-{userAddress}-{txHash}-{logIndex}
  contractAddress: Bytes! # Genesis contract address
  user: Bytes! # User address
  amount: BigInt! # Amount deposited (in wei)
  amountUSD: BigDecimal # USD value at time of deposit
  timestamp: BigInt! # Block timestamp
  txHash: Bytes! # Transaction hash
  blockNumber: BigInt! # Block number
  # Harbor Marks tracking
  marksPerDay: BigDecimal! # Marks per day rate for this deposit
  isActive: Boolean! # Whether this deposit is still active (not withdrawn)
  # Withdrawal tracking
  withdrawnAmount: BigInt! # Amount withdrawn (0 if not withdrawn)
  withdrawnAt: BigInt # Timestamp when withdrawn (null if not withdrawn)
  # Early deposit bonus tracking
  qualifiesForEarlyBonus: Boolean! # Whether this deposit qualifies for early bonus (deposited before threshold)
  earlyBonusAmount: BigDecimal! # Bonus marks this deposit would earn (100 marks per dollar)
}

type Withdrawal @entity(immutable: true) {
  id: ID! # {contractAddress}-{userAddress}-{txHash}-{logIndex}
  contractAddress: Bytes! # Contract address
  user: Bytes! # User address
  amount: BigInt! # Amount withdrawn (in wei)
  amountUSD: BigDecimal # USD value at time of withdrawal
  timestamp: BigInt! # Block timestamp
  txHash: Bytes! # Transaction hash
  blockNumber: BigInt! # Block number
  # Marks forfeited
  marksForfeited: BigDecimal! # Marks forfeited due to this withdrawal
}

type GenesisEnd @entity(immutable: true) {
  id: ID! # {contractAddress}
  contractAddress: Bytes! # Genesis contract address
  timestamp: BigInt! # Block timestamp when genesis ended
  txHash: Bytes! # Transaction hash
  blockNumber: BigInt! # Block number
}

type UserHarborMarks @entity(immutable: false) {
  id: ID! # {contractAddress}-{userAddress}
  contractAddress: Bytes! # Contract address
  user: Bytes! # User address
  # Current marks
  currentMarks: BigDecimal! # Current marks earned (accumulated)
  marksPerDay: BigDecimal! # Current marks per day rate
  # Historical
  totalMarksEarned: BigDecimal! # Total marks ever earned
  totalMarksForfeited: BigDecimal! # Total marks forfeited from withdrawals
  bonusMarks: BigDecimal! # Bonus marks from genesis end (100 marks per dollar)
  # Deposits
  totalDeposited: BigInt! # Total amount ever deposited
  totalDepositedUSD: BigDecimal! # Total deposited in USD
  currentDeposit: BigInt! # Current active deposit
  currentDepositUSD: BigDecimal! # Current active deposit in USD
  # Genesis period
  genesisStartDate: BigInt! # Genesis start timestamp
  genesisEndDate: BigInt # Genesis end timestamp (null if not ended)
  genesisEnded: Boolean! # Whether genesis has ended
  # Early deposit bonus
  qualifiesForEarlyBonus: Boolean! # Whether user has any qualifying deposits
  earlyBonusMarks: BigDecimal! # Early bonus marks earned (calculated at genesis end)
  earlyBonusEligibleDepositUSD: BigDecimal! # USD value of deposits that qualify for bonus (reduces on withdrawal)
  # Last updated
  lastUpdated: BigInt! # Last block timestamp when updated
}

type UserList @entity(immutable: false) {
  id: ID! # {contractAddress}
  contractAddress: Bytes! # Contract address
  users: [Bytes!]! # Array of user addresses who have deposits
}

# Market-level early deposit bonus tracking
type MarketBonusStatus @entity(immutable: false) {
  id: ID! # {contractAddress}
  contractAddress: Bytes! # Genesis contract address
  thresholdReached: Boolean! # Whether threshold has been reached
  thresholdReachedAt: BigInt # Block timestamp when threshold was reached (null if not reached)
  cumulativeDeposits: BigDecimal! # Cumulative deposits in token amounts (fxUSD or wstETH)
  thresholdAmount: BigDecimal! # 250000 fxUSD tokens for fxSAVE markets, 70 wstETH tokens for wstETH markets
  thresholdToken: String! # "fxSAVE" or "wstETH"
  lastUpdated: BigInt! # Last update timestamp
}

# ============ Entities for Multi-Market Marks Tracking ============

# Tracks ha token balances (from ERC20 transfers)
type HaTokenBalance @entity(immutable: false) {
  id: ID! # {tokenAddress}-{userAddress}
  tokenAddress: Bytes! # ha token contract address
  user: Bytes! # User address
  balance: BigInt! # Current token balance
  balanceUSD: BigDecimal! # Current balance in USD
  # Marks tracking
  marksPerDay: BigDecimal! # Current marks per day rate
  accumulatedMarks: BigDecimal! # Marks accumulated from this balance
  totalMarksEarned: BigDecimal! # Total marks ever earned from this token
  # Tracking
  firstSeenAt: BigInt! # First time user had balance > 0
  lastUpdated: BigInt! # Last block timestamp when updated
  # Market info
  marketId: String # Market identifier (optional, for grouping)
}

# Tracks sail token balances (from ERC20 transfers) - leveraged tokens with 5x multiplier
type SailTokenBalance @entity(immutable: false) {
  id: ID! # {tokenAddress}-{userAddress}
  tokenAddress: Bytes! # sail token contract address
  user: Bytes! # User address
  balance: BigInt! # Current token balance
  balanceUSD: BigDecimal! # Current balance in USD
  # Marks tracking
  marksPerDay: BigDecimal! # Current marks per day rate (includes 5x multiplier)
  accumulatedMarks: BigDecimal! # Marks accumulated from this balance
  totalMarksEarned: BigDecimal! # Total marks ever earned from this token
  # Tracking
  firstSeenAt: BigInt! # First time user had balance > 0
  lastUpdated: BigInt! # Last block timestamp when updated
  # Market info
  marketId: String # Market identifier (optional, for grouping)
}

# Tracks stability pool deposits
type StabilityPoolDeposit @entity(immutable: false) {
  id: ID! # {poolAddress}-{userAddress}
  poolAddress: Bytes! # Stability pool contract address
  user: Bytes! # User address
  balance: BigInt! # Current deposit balance
  balanceUSD: BigDecimal! # Current balance in USD
  # Marks tracking
  marksPerDay: BigDecimal! # Current marks per day rate
  accumulatedMarks: BigDecimal! # Marks accumulated from this deposit
  totalMarksEarned: BigDecimal! # Total marks ever earned from this pool
  # Tracking
  firstDepositAt: BigInt! # First deposit timestamp
  lastUpdated: BigInt! # Last block timestamp when updated
  # Pool type
  poolType: String! # "collateral" or "sail"
  # Market info
  marketId: String # Market identifier (optional, for grouping)
}

# Tracks marks multiplier configuration (updatable)
type MarksMultiplier @entity(immutable: false) {
  id: ID! # {sourceType}-{sourceAddress} or "global"
  sourceType: String! # "haToken", "stabilityPoolCollateral", "stabilityPoolSail", "genesis", or "global"
  sourceAddress: Bytes # Contract address (null for global)
  multiplier: BigDecimal! # Multiplier (1.0 = 1 mark/dollar/day, 2.0 = 2 marks/dollar/day, etc.)
  effectiveFrom: BigInt! # Block timestamp when multiplier became effective
  updatedAt: BigInt! # Last update timestamp
  updatedBy: Bytes # Address that updated (null if system)
}

# Per-market marks boost window (for “first 8 days” boosts)
type MarketBoostWindow @entity(immutable: false) {
  id: ID! # {sourceType}-{sourceAddress}
  sourceType: String! # "haToken" | "sailToken" | "stabilityPoolCollateral" | "stabilityPoolLeveraged"
  sourceAddress: Bytes! # Contract address for the token/pool
  startTimestamp: BigInt! # Start of boost window (set once on first indexed activity)
  endTimestamp: BigInt! # startTimestamp + duration
  boostMultiplier: BigDecimal! # 10.0 for anchor sources, 2.0 for sailToken
}

# Tracks price feeds for USD calculations
type PriceFeed @entity(immutable: false) {
  id: ID! # {tokenAddress}
  tokenAddress: Bytes! # Token contract address
  priceFeedAddress: Bytes! # Price oracle address
  priceUSD: BigDecimal! # Current price in USD
  decimals: Int! # Price feed decimals
  lastUpdated: BigInt! # Last update timestamp
}

# Aggregated user marks across all sources
type UserTotalMarks @entity(immutable: false) {
  id: ID! # {userAddress}
  user: Bytes! # User address
  # Marks by source
  genesisMarks: BigDecimal! # Marks from Genesis deposits
  haTokenMarks: BigDecimal! # Marks from ha token balances (anchor tokens, 1x multiplier)
  sailTokenMarks: BigDecimal! # Marks from sail token balances (leveraged tokens, 5x multiplier)
  stabilityPoolMarks: BigDecimal! # Marks from stability pool deposits
  # Totals
  totalMarks: BigDecimal! # Total marks across all sources
  totalMarksPerDay: BigDecimal! # Total marks per day rate
  # Last updated
  lastUpdated: BigInt! # Last block timestamp when updated
}

# ============ Entities for Sail Token Price History & PnL ============

# Track each mint/redeem/genesis event with price data (for price charts)
type SailTokenPricePoint @entity(immutable: true) {
  id: ID! # "{tokenAddress}-{txHash}-{logIndex}"
  tokenAddress: Bytes! # Sail token address
  minterAddress: Bytes! # Minter contract address
  blockNumber: BigInt!
  timestamp: BigInt!
  txHash: Bytes!
  
  # Price data at time of event
  tokenPriceUSD: BigDecimal! # Sail token price in USD
  collateralPriceUSD: BigDecimal! # Underlying collateral price in USD
  wrappedRate: BigDecimal! # Wrapped to underlying conversion rate
  
  # Event details
  eventType: String! # "mint" | "redeem" | "genesis" | "hourly"
  collateralAmount: BigInt! # Collateral in/out (0 for hourly snapshots)
  tokenAmount: BigInt! # Sail tokens minted/redeemed (0 for hourly)
  
  # Derived price from event (collateralAmount * price / tokenAmount)
  impliedTokenPrice: BigDecimal # Implied price from this transaction
}

# Hourly price snapshots for continuous chart data
type HourlyPriceSnapshot @entity(immutable: true) {
  id: ID! # "{tokenAddress}-{hourTimestamp}"
  tokenAddress: Bytes! # Sail token address
  minterAddress: Bytes! # Minter contract address
  hourTimestamp: BigInt! # Hour start timestamp (rounded down to hour)
  blockNumber: BigInt! # Block number when snapshot was taken
  
  # Price data
  tokenPriceUSD: BigDecimal! # Sail token price in USD
  collateralPriceUSD: BigDecimal! # Underlying collateral price
  wrappedRate: BigDecimal! # Wrapped to underlying rate
  
  # Market data at this hour
  totalSupply: BigInt! # Total sail token supply
  collateralBalance: BigInt! # Total collateral in minter
  leverageRatio: BigInt! # Current leverage ratio (18 decimals)
  collateralRatio: BigInt! # Current collateral ratio (18 decimals)
}

# Tracks when last price was recorded per token (for hourly logic)
type PriceTracker @entity(immutable: false) {
  id: ID! # "{tokenAddress}"
  tokenAddress: Bytes!
  minterAddress: Bytes!
  oracleAddress: Bytes!
  lastPriceTimestamp: BigInt! # Timestamp of last price point
  lastHourlySnapshot: BigInt! # Hour timestamp of last hourly snapshot
  lastBlockNumber: BigInt! # Block number of last update
}

# Per-minter tracker so we can write hourly snapshots from a block handler without doing
# expensive onchain reads every block.
type MinterHourlyTracker @entity(immutable: false) {
  id: ID! # "{minterAddress}"
  minterAddress: Bytes!
  tokenAddress: Bytes!
  lastHourTimestamp: BigInt! # Hour timestamp of last snapshot attempt
}

# User's sail token position with cost basis (for PnL)
type UserSailPosition @entity(immutable: false) {
  id: ID! # "{tokenAddress}-{userAddress}"
  tokenAddress: Bytes! # Sail token address
  user: Bytes! # User address
  
  # Current position
  balance: BigInt! # Current token balance
  balanceUSD: BigDecimal! # Current value in USD
  
  # Cost basis (aggregated from lots)
  totalCostBasisUSD: BigDecimal! # Sum of all remaining lots' cost
  averageCostPerToken: BigDecimal! # Total cost / balance
  
  # Realized P&L
  realizedPnLUSD: BigDecimal! # Realized profit/loss from redeems
  
  # Lifetime stats
  totalTokensBought: BigInt! # Total tokens ever acquired (mint + genesis)
  totalTokensSold: BigInt! # Total tokens ever sold (redeem)
  totalSpentUSD: BigDecimal! # Total USD spent to acquire tokens
  totalReceivedUSD: BigDecimal! # Total USD received from redeems
  
  # Tracking
  firstAcquiredAt: BigInt! # First acquisition timestamp
  lastUpdated: BigInt! # Last update timestamp
  
  # Reference to lots
  lots: [CostBasisLot!]! @derivedFrom(field: "position")
}

# Individual cost basis lots for FIFO tracking
type CostBasisLot @entity(immutable: false) {
  id: ID! # "{positionId}-{index}"
  position: UserSailPosition! # Parent position
  lotIndex: Int! # Index in FIFO queue (0 = oldest)
  
  # Lot details
  tokenAmount: BigInt! # Remaining tokens in this lot
  originalAmount: BigInt! # Original tokens when lot was created
  costUSD: BigDecimal! # Remaining cost basis for this lot
  originalCostUSD: BigDecimal! # Original cost when lot was created
  pricePerToken: BigDecimal! # USD price per token when acquired
  
  # Source
  eventType: String! # "mint" | "genesis"
  timestamp: BigInt! # When lot was created
  blockNumber: BigInt!
  txHash: Bytes!
  
  # Status
  isFullyRedeemed: Boolean! # True if tokenAmount == 0
}

# Mint/Redeem events (immutable log)
type SailTokenMintEvent @entity(immutable: true) {
  id: ID! # "{txHash}-{logIndex}"
  tokenAddress: Bytes!
  minterAddress: Bytes!
  user: Bytes! # Receiver
  
  collateralIn: BigInt!
  feeIn: BigInt!
  leveragedOut: BigInt!
  
  # USD values at time of event
  collateralValueUSD: BigDecimal!
  tokenValueUSD: BigDecimal!
  pricePerToken: BigDecimal!
  
  timestamp: BigInt!
  blockNumber: BigInt!
  txHash: Bytes!
}

type SailTokenRedeemEvent @entity(immutable: true) {
  id: ID! # "{txHash}-{logIndex}"
  tokenAddress: Bytes!
  minterAddress: Bytes!
  user: Bytes! # Sender
  
  leveragedBurned: BigInt!
  collateralOut: BigInt!
  
  # USD values at time of event
  collateralValueUSD: BigDecimal!
  tokenValueUSD: BigDecimal!
  pricePerToken: BigDecimal!
  
  # PnL for this redeem
  costBasisUSD: BigDecimal! # Cost basis of tokens redeemed (FIFO)
  realizedPnLUSD: BigDecimal! # Profit/loss from this redeem
  
  timestamp: BigInt!
  blockNumber: BigInt!
  txHash: Bytes!
}

# ============ Sail PnL: Genesis-derived cost basis ============
#
# This entity is used by the sail-tokens subgraph to attribute cost basis to
# leveraged (hs) tokens minted via the Genesis process.
type SailGenesisUser @entity(immutable: false) {
  id: ID! # "{genesisAddress}-{userAddress}"
  genesisAddress: Bytes!
  user: Bytes!
  netDeposit: BigInt! # Net deposited wrapped collateral (deposits - withdrawals)
  netDepositUSD: BigDecimal! # Net deposited value in USD at time of each event (running total)
  lastUpdated: BigInt!
}
